// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("user") // admin, user
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relaciones
  tareasAsignadas          Tarea[]
  comunicacionesRegistradas Comunicacion[]
}

model Cliente {
  id          String   @id @default(cuid())
  rut         String   @unique
  razonSocial String   // Razón social o nombre de la empresa
  contacto    String?  // Nombre del contacto principal
  telefono    String?
  email       String?
  notas       String?
  estado      String   @default("activo") // activo, inactivo, prospecto
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  accesos         Acceso[]
  proyectos       Proyecto[]
  facturas        Factura[]
  cotizaciones    Cotizacion[]
  suscripciones   Suscripcion[]
  comunicaciones  Comunicacion[]
}

model Acceso {
  id        String   @id @default(cuid())
  nombre    String   // Nombre descriptivo (ej: "Correo corporativo", "Servidor web")
  tipo      String   // hosting, cpanel, email, ftp, ssh, db, vpn, cloud, otro
  url       String?  // URL o IP de acceso
  puerto    String?  // Puerto (ej: 22, 3306, 21)
  usuario   String?  // Usuario o login
  password  String?  // Contraseña
  notas     String?  // Notas adicionales
  clienteId String?
  cliente   Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Nota {
  id        String   @id @default(cuid())
  titulo    String
  contenido String
  favorita  Boolean  @default(false) // Notas importantes para mostrar en dashboard
  color     String   @default("slate") // slate, cyan, violet, emerald, amber, rose
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Enlace {
  id          String   @id @default(cuid())
  nombre      String   // Nombre del enlace (ej: "Portainer", "VPN Empresa")
  url         String   // URL completa
  categoria   String   @default("otros") // infraestructura, monitoreo, desarrollo, documentacion, otros
  descripcion String?  // Descripción opcional
  icono       String   @default("link") // link, server, shield, cloud, code, database, monitor, folder
  orden       Int      @default(0) // Para ordenar los enlaces
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Servicio {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  precio      Float
  tipo        String   @default("mensual") // mensual, anual, unico, hora
  categoria   String   @default("general") // hosting, desarrollo, mantenimiento, consultoria
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  suscripciones Suscripcion[]
  itemsFactura  ItemFactura[]
  itemsCotizacion ItemCotizacion[]
}

model Suscripcion {
  id          String   @id @default(cuid())
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  servicioId  String
  servicio    Servicio @relation(fields: [servicioId], references: [id])
  
  precio      Float    // Precio acordado (puede diferir del precio de lista del servicio)
  ciclo       String   @default("mensual") // mensual, anual, trimestral
  fechaInicio DateTime
  fechaFin    DateTime?
  proxCobro   DateTime?
  estado      String   @default("activa") // activa, pausada, cancelada, pendiente
  notas       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Proyecto {
  id          String   @id @default(cuid())
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  
  nombre      String
  descripcion String?
  estado      String   @default("planificacion") // planificacion, desarrollo, pruebas, completado, pausado, cancelado
  prioridad   String   @default("media") // baja, media, alta, urgente
  fechaInicio DateTime?
  fechaFin    DateTime?
  presupuesto Float?
  avance      Int      @default(0) // Porcentaje 0-100
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  tareas      Tarea[]
  facturas    Factura[] // Proyectos pueden generar facturas
}

model Tarea {
  id          String   @id @default(cuid())
  proyectoId  String
  proyecto    Proyecto @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  
  titulo      String
  descripcion String?
  estado      String   @default("pendiente") // pendiente, en_progreso, revision, completada
  prioridad   String   @default("media") // baja, media, alta
  fechaVenc   DateTime?
  
  asignadoAId String?
  asignadoA   User?    @relation(fields: [asignadoAId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Factura {
  id          String   @id @default(cuid())
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  
  numero      String   @unique // Folio o número interno
  numeroSII   String?  // Número de factura SII (Servicio de Impuestos Internos)
  fechaEmision DateTime @default(now())
  fechaVenc   DateTime
  estado      String   @default("emitida") // emitida, enviada, pendiente, pagada, cancelada, vencida
  moneda      String   @default("CLP") // CLP, USD, UF
  subtotal    Float
  impuesto    Float    @default(0) // IVA u otros
  total       Float
  notas       String?
  
  proyectoId  String?
  proyecto    Proyecto? @relation(fields: [proyectoId], references: [id])
  
  cotizacionId String?
  cotizacion   Cotizacion? @relation(fields: [cotizacionId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  items       ItemFactura[]
  pagos       Pago[]
}

model ItemFactura {
  id          String   @id @default(cuid())
  facturaId   String
  factura     Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  
  servicioId  String?
  servicio    Servicio? @relation(fields: [servicioId], references: [id])
  
  descripcion String
  cantidad    Float    @default(1)
  precioUnit  Float
  total       Float
}

model Pago {
  id          String   @id @default(cuid())
  facturaId   String
  factura     Factura  @relation(fields: [facturaId], references: [id])
  
  monto       Float
  fecha       DateTime @default(now())
  metodo      String   // transferencia, tarjeta, efectivo, cheque
  referencia  String?  // Nro de comprobante
  notas       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Cotizacion {
  id          String   @id @default(cuid())
  clienteId   String?  // Puede ser a un prospecto aún no registrado como cliente, pero lo ideal es registrarlo como prospecto
  cliente     Cliente? @relation(fields: [clienteId], references: [id])
  
  numero      String   @unique
  fecha       DateTime @default(now())
  validez     DateTime // Fecha hasta la cual es válida
  estado      String   @default("borrador") // borrador, enviada, aprobada, rechazada, vencida
  moneda      String   @default("CLP")
  subtotal    Float
  impuesto    Float    @default(0)
  total       Float
  notas       String?
  
  nombreProspecto String? // Si no hay clienteId
  emailProspecto  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  items       ItemCotizacion[]
  facturas    Factura[] // Facturas generadas desde esta cotización
}

model ItemCotizacion {
  id          String     @id @default(cuid())
  cotizacionId String
  cotizacion  Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  
  servicioId  String?
  servicio    Servicio?  @relation(fields: [servicioId], references: [id])
  
  descripcion String
  cantidad    Float      @default(1)
  precioUnit  Float
  total       Float
}

model Comunicacion {
  id          String   @id @default(cuid())
  clienteId   String
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  
  tipo        String   // email, telefono, reunion, whatsapp
  fecha       DateTime @default(now())
  resumen     String
  detalle     String?
  resultado   String?  // Resultado de la interacción
  
  usuarioId   String
  usuario     User     @relation(fields: [usuarioId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Gasto {
  id          String   @id @default(cuid())
  monto       Float
  motivo     String   // Descripción del gasto
  categoria   String   // servicios, insumos, software, hardware, marketing, otros
  fecha       DateTime @default(now())
  proveedor   String?  // Nombre del proveedor
  comprobante String?  // Ruta del archivo del comprobante
  notas       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
